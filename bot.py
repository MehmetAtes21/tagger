import os, logging, asyncio
from telethon import Button
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from telethon.tl.types import ChannelParticipantsAdmins

from datetime import datetime

from pyrogram import filters
from pyrogram.errors import PeerIdInvalid
from pyrogram.types import Message, User
from pyrogram.types.messages_and_media import Message
from pyrogram import Client, filters
import time

import datetime
import motor.motor_asyncio
from motor.motor_asyncio import AsyncIOMotorClient as MongoClient
import asyncio
import datetime
import shutil, psutil, traceback, os
import random
import string
import time
import traceback
import aiofiles
from pyrogram import Client, filters, __version__
from pyrogram.types import Message
from pyrogram.errors import (
    FloodWait,
    InputUserDeactivated,
    PeerIdInvalid,
    UserIsBlocked,
)


logging.basicConfig(
    level=logging.INFO,
    format='%(name)s - [%(levelname)s] - %(message)s'
)
LOGGER = logging.getLogger(__name__)

api_id = int(os.environ.get("APP_ID"))
api_hash = os.environ.get("API_HASH")
bot_token = os.environ.get("TOKEN")
BOT_USERNAME = os.environ.get("BOT_USERNAME") # Botunuzun kullanÄ±cÄ± adÄ±.
LOG_CHANNEL = int(os.environ.get("LOG_CHANNEL")) # Botunuzun eylemleri kaydedeceÄŸi kayÄ±t grubunun id'si.
GROUP_SUPPORT = os.environ.get("GROUP_SUPPORT", "SohbetGoVip") # Botunuzdan yasaklanan kullanÄ±cÄ±larÄ±n itiraz iÅŸlemleri iÃ§in baÅŸvuracaÄŸÄ± grup, kanal veya kullanÄ±cÄ±. BoÅŸ bÄ±rakÄ±rsanÄ±z otomatik olarak OWNER_ID kimliÄŸine yÃ¶nlendirecektir.
OWNER_ID = int(os.environ.get("OWNER_ID")) # Sahip hesabÄ±n id'si

client = TelegramClient('client', api_id, api_hash).start(bot_token=bot_token)

app = Client("GUNC",
             api_id=api_id,
             api_hash=api_hash,
             bot_token=bot_token
             )

anlik_calisan = []

ozel_list = [5105453716]
anlik_calisan = []
grup_sayi = []
etiketuye = []
rxyzdev_tagTot = {}
rxyzdev_initT = {}


@client.on(events.NewMessage(pattern="^/start$"))
async def info(event):
  await event.reply("**Merhaba Benim Ve Sahibim HakkÄ±nda Bilgi\n\nPython: 3.8.2\nKÃ¼tÃ¼phanem: Telethon\n\nSahibim:  GruplarÄ±nÄ±zda Ãœyeleri Etiketlemek iÃ§in YaratÄ±lmÄ±ÅŸÄ±m**",
                    buttons=(
                      [
                       Button.url('Beni Grubuna Ekle â•', 'https://t.me/Startaggerbot?startgroup=a')
                      ],
                      [
                       Button.url('ğŸ“¢ Kanal', 'https://t.me/StarBotKanal'),
                       Button.url('ğŸ‡¹ğŸ‡· Sahibim', 'https://t.me/Hayiboo')
                      ],
                      [
                       Button.url('ğŸ§‘ğŸ»â€ğŸ’» É¢Éªá´›Êœá´œÊ™ á´‹á´€ÊÉ´á´€á´‹ á´‹á´á´…á´œ ğŸ§‘ğŸ»â€ğŸ’»', 'https://github.com/MehmetAtes21/Tagger')
                      ],
                    ),
                    link_preview=False
                   )

@client.on(events.NewMessage(pattern='^(?i)/cancel'))
async def cancel(event):
  global anlik_calisan
  anlik_calisan.remove(event.chat_id)
  
  if event.chat_id in rxyzdev_tagTot:await event.respond(f"âŒ**Etiket iÅŸlemi durduruldu.\n\n Etiketlerin SayÄ±: {rxyzdev_tagTot[event.chat_id]}**")


@client.on(events.NewMessage(pattern="^/start$"))
async def start(event):
  if event.is_private:
    async for usr in client.iter_participants(event.chat_id):
     ad = f"[{usr.first_name}](tg://user?id={usr.id}) "
     await client.send_message(-1001752620477, f"â„¹ï¸ **Yeni KullanÄ±cÄ± -** {ad}")
     return await event.reply(f"**Merhaba \nGrubunuzdakÄ± Ãœyeleri Etiketleye Bilirim\nKomutlar iÃ§in Komutlar DÃ¼ÄŸmesine TÄ±klaya Bilirsiz**", buttons=(
                      [
                       Button.inline("Komutlar", data="komutlar")
                      ],
                      [
                       Button.url('Beni Grubuna Ekle', 'https://t.me/StartaggerBot?startgroup=a'),
                       Button.url('Kanal', 'https://t.me/StarBotKanal')
                      ],
                      [
                       Button.url('Sahibim', 'https://t.me/Hayiboo')
                      ],
                    ),
                    link_preview=False)


  if event.is_group:
    return await client.send_message(event.chat_id, f"**Beni Grubuna AldÄ±ÄŸÄ±n iÃ§in TeÅŸekkÃ¼rler âœ¨**")

# BaÅŸlanÄŸÄ±c Button
@client.on(events.callbackquery.CallbackQuery(data="start"))
async def handler(event):
    async for usr in client.iter_participants(event.chat_id):
     ad = f"[{usr.first_name}](tg://user?id={usr.id}) "
     await event.edit(f"**Merhaba Ben @MinaTagBot\nGrubunuzdakÄ± Ãœyeleri Etiketleye Bilirim\nKomutlar iÃ§in Komutlar DÃ¼ÄŸmesine TÄ±klaya Bilirsiz**", buttons=(
                      [
                       Button.inline("Komutlar", data="komutlar")
                      ],
                      [
                       Button.url('Beni Grubuna Ekle', 'https://t.me/StartaggerBot?startgroup=a'),
                       Button.url('Kanal', 'https://t.me/StarBotKanal')
                      ],
                      [
                       Button.url('Sahibim', 'https://t.me/Hayiboo')
                      ],
                    ),
                    link_preview=False)

# gece kusu
@client.on(events.callbackquery.CallbackQuery(data="komutlar"))
async def handler(event):
    await event.edit(f"**KomutlarÄ±m:\n\n/all -text-\n/atag -text-\n/cancel - Ä°ÅŸlemi Durdururum...\n\nâ• YalnÄ±zca yÃ¶neticileri bu komutlarÄ± kullanabilir.**", buttons=(
                      [
                      Button.inline("â—€ï¸ Geri", data="start")
                      ]
                    ),
                    link_preview=False)


@client.on(events.NewMessage())
async def mentionalladmin(event):
  global etiketuye
  if event.is_group:
    if event.chat_id in etiketuye:
      pass
    else:
      etiketuye.append(event.chat_id)

@client.on(events.NewMessage(pattern="^/all ?(.*)"))
async def mentionall(event):
  global anlik_calisan
  rxyzdev_tagTot[event.chat_id] = 0
  if event.is_private:
    return await event.respond("**Bu Komut Sadace Grublarda ve Kanallarda KullanÄ±ma Bilir**")
  
  admins = []
  async for admin in client.iter_participants(event.chat_id):
    admins.append(admin.id)
  if not event.sender_id in admins:
    return await event.respond("**YalnÄ±zca YÃ¶neticiler Etiket iÅŸlemini Yapabilir**")
  
  if event.pattern_match.group(1):
    mode = "text_on_cmd"
    msg = event.pattern_match.group(1)
  elif event.reply_to_msg_id:
    mode = "text_on_reply"
    msg = event.reply_to_msg_id
    if msg == None:
        return await event.respond("**Eski Mesajlar iÃ§in Ãœyelerden Bahsedemem! (gruba eklemeden Ã¶nce gÃ¶nderilen mesajlar)**")
  elif event.pattern_match.group(1) and event.reply_to_msg_id:
    return await event.respond("**Bana Bir Metin Ver!**")
  else:
    return await event.respond("**Bir MesajÄ± YanÄ±tlayÄ±n veya BaÅŸkalarÄ±ndan Bahsetmem iÃ§in Bana Bir Betin Verin!!**")
  
  if mode == "text_on_cmd":
    anlik_calisan.append(event.chat_id)
    usrnum = 0
    usrtxt = ""
    await event.respond(f"**Etiket iÅŸlemi BaÅŸarÄ±yla BaÅŸlatÄ±ldÄ±.!**")
        
    async for usr in client.iter_participants(event.chat_id, aggressive=False):
      rxyzdev_tagTot[event.chat_id] += 1
      usrnum += 1
      usrtxt += f"\nğŸ‘¤ - [{usr.first_name}](tg://user?id={usr.id}) "
      if event.chat_id not in anlik_calisan:
        return
      if usrnum == 5:
        await client.send_message(event.chat_id, f"{msg}\n{usrtxt}")
        await asyncio.sleep(3)
        usrnum = 0
        usrtxt = ""
        
    sender = await event.get_sender()
    rxyzdev_initT = f"[{sender.first_name}](tg://user?id={sender.id})"
    if event.chat_id in rxyzdev_tagTot:await event.respond(f"**âœ… Etiket Ä°ÅŸlemi BaÅŸarÄ±yla TamamlandÄ± !.\n\nEtiketlerin SaylarÄ±: {rxyzdev_tagTot[event.chat_id]}\n\nEtiket Ä°ÅŸlemini BaÅŸlatan: {rxyzdev_initT}**")
  
  if mode == "text_on_reply":
    anlik_calisan.append(event.chat_id)
 
    usrnum = 0
    usrtxt = ""
    async for usr in client.iter_participants(event.chat_id, aggressive=False):
      rxyzdev_tagTot[event.chat_id] += 1
      usrnum += 1
      usrtxt += f"\nğŸ‘¤ - [{usr.first_name}](tg://user?id={usr.id}) "
      if event.chat_id not in anlik_calisan:
        return
      if usrnum == 5:
        await client.send_message(event.chat_id, usrtxt, reply_to=msg)
        await asyncio.sleep(2)
        usrnum = 0
        usrtxt = ""
     
    sender = await event.get_sender()
    rxyzdev_initT = f"[{sender.first_name}](tg://user?id={sender.id})"      
    if event.chat_id in rxyzdev_tagTot:await event.respond(f"**âœ… Etiket Ä°ÅŸlemi BaÅŸarÄ±yla TamamlandÄ± !.\n\nEtiketlerin SaylarÄ±: {rxyzdev_tagTot[event.chat_id]}\n\nEtiket Ä°ÅŸlemini BaÅŸlatan: {rxyzdev_initT}**")

@client.on(events.NewMessage(pattern="^/atag ?(.*)"))
async def mentionalladmin(event):
  global anlik_calisan
  if event.is_private:
    return await event.respond("**Bu Komut YalnÄ±zca Grublarda Ve Kanallarda KullanÄ±ma Bilir!**")
  
  admins = []
  async for admin in client.iter_participants(event.chat_id):
    admins.append(admin.id)
  if not event.sender_id in admins:
    return await event.respond("**YalnÄ±zca YÃ¶neticiler Etiket Ä°ÅŸlemini Yapabilir**")
  
  if event.pattern_match.group(1):
    mode = "text_on_cmd"
    msg = event.pattern_match.group(1)
  elif event.reply_to_msg_id:
    mode = "text_on_reply"
    msg = event.reply_to_msg_id
    if msg == None:
        return await event.respond("**Eski Mesajlar iÃ§in Ãœyelerden Bahsedemem! (gruba eklemeden Ã¶nce gÃ¶nderilen mesajlar)**")
  elif event.pattern_match.group(1) and event.reply_to_msg_id:
    return await event.respond("**Bana Bir Metin Ver!**")
  else:
    return await event.respond("**Bir MesajÄ± YanÄ±tlayÄ±n veya BaÅŸkalarÄ±ndan Bahsetmem iÃ§in Bana Bir Betin Verin!**")
  
  if mode == "text_on_cmd":
    anlik_calisan.append(event.chat_id)
    usrnum = 0
    usrtxt = ""
    await event.respond("**Admin Etiket iÅŸlemi BaÅŸarÄ±yla BaÅŸlatÄ±ldÄ±.!**")
  
    async for usr in client.iter_participants(event.chat_id,filter=ChannelParticipantsAdmins):
      usrnum += 1
      usrtxt += f"\n**ğŸ‘¤ - [{usr.first_name}](tg://user?id={usr.id}) **"
      if event.chat_id not in anlik_calisan:
        await event.respond("**Etiket Ä°ÅŸlemi Bitti.!**")
        return
      if usrnum == 5:
        await client.send_message(event.chat_id, f"{msg}\n\n{usrtxt}")
        await asyncio.sleep(3)
        usrnum = 0
        usrtxt = ""
        
  
  if mode == "text_on_reply":
    anlik_calisan.append(event.chat_id)
 
    usrnum = 0
    usrtxt = ""
    async for usr in client.iter_participants(event.chat_id,filter=ChannelParticipantsAdmins):
      usrnum += 1
      usrtxt += f"\n**ğŸ‘¤ - [{usr.first_name}](tg://user?id={usr.id}) **"
      if event.chat_id not in anlik_calisan:
        await event.respond("**Ä°ÅŸlem Durduruldu.!**")
        return
      if usrnum == 5:
        await client.send_message(event.chat_id, usrtxt, reply_to=msg)
        await asyncio.sleep(3)
        usrnum = 0
        usrtxt = ""

    sender = await event.get_sender()
    rxyzdev_initT = f"[{sender.first_name}](tg://user?id={sender.id})"
    if event.chat_id in rxyzdev_tagTot:await event.respond(f"**Etiket Ä°ÅŸlemi BaÅŸarÄ±yla TamamlandÄ± !.\n\n**Etiketlerin SaylarÄ±: {rxyzdev_tagTot[event.chat_id]}\n\nEtiket Ä°ÅŸlemini BaÅŸlatan: {rxyzdev_initT}")



app.run()
print(">> Bot Ã§alÄ±ÅŸÄ±yor @Hayiboo TarafÄ±ndan Kuruldu<<")
client.run_until_disconnected()
